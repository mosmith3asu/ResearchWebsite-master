{% extends "base.html" %}
{% block title %} Pursuit Game {% endblock %}

{#<!-- Specific Page CSS goes HERE  -->#}
{% block stylesheets %}
{% endblock stylesheets %}#}
{% block content %}
<main>
  <div id = "master-frame">

    <div id="canvas-frame">
      <canvas id="canvas"  style = "border: 1px solid blue" width="700" height="700"></canvas>
    </div>

    <div id="survey-frame">
      <form id="survey-form">
        <table id = survey-table></table>
      </form>
      <button id="submit-survey-button">Submit</button>
    </div>


    <div id="info-frame">
      <img id="info-page-img"
           src="https://s3-alpha.figma.com/hub/file/948140848/1f4d8ea7-e9d9-48b7-b70c-819482fb10fb-cover.png"
           alt="img">
    </div>

    <div id="nav-buttons-frame">
      <button id="back-button">Back</button>
      <button id="continue-button">Continue</button>
    </div>
  </div>



  <script script src="{{ url_for('static', filename='scripts/client_socket.js') }}"></script>
  <script script src="{{ url_for('static', filename='scripts/game_obj.js') }}"></script>
  <script script src="{{ url_for('static', filename='scripts/page_handler.js') }}"></script>

  <script>

    const FRAMES = ['canvas-frame','info-frame','survey-frame']
    const HAS_NAV_BUTTONS = ['info-frame']
    spawn_elements()
    var current_view = '';
    const update_rate = 100; // in miliseconds
    const host = 'http://192.168.0.137:8080'
    // const update_gamestate_name = 'update_gamestate'
    // const render_route = '/render_PursuitGame' //  "/"
    const render_route = "/"
    const game_end_redirect = false


    const masterFrame = document.getElementById("master-frame");
    masterFrame.style.margin = "auto";
    masterFrame.style.width = "80%";
    masterFrame.style.top = "200px";
    masterFrame.style.left = "10%";
    masterFrame.style.height = '700px'
    masterFrame.style.border = '1px solid red'

    // masterFrame.clientHeight
    // masterFrame.clientWidth

    // INFO FRAME ==========================================
    const infoPage = document.getElementById("info-frame");
    infoPage.style.height = masterFrame.clientHeight/2
    infoPage.style.width = masterFrame.clientWidth
    infoPage.style.position = 'absolute'
    infoPage.style.top = '100px'
    // infoPage.style.height = '300px';
    // infoPage.style.margin = "auto";
    // infoPage.style.width = "80%";
    // infoPage.style.left = "10%";
    // infoPage.style.border = '1px solid red'

    const infoPageImg = document.getElementById("info-page-img");
    infoPageImg.style.height = infoPage.clientHeight/2
    infoPageImg.style.top = infoPage.clientHeight / 2 - infoPageImg.height / 2 + 'px';
    infoPageImg.style.left =  infoPage.clientWidth / 2 - infoPageImg.width / 2 + 'px';
    infoPageImg.style.position = 'absolute'

    // NAV-Buttons ==========================================
    const navButtons = document.getElementById("survey-frame");
    navButtons.style.top = "700px"
    // navButtons.style.display = 'flex'
    // navButtons.style.justifyContent = 'center'
    // navButtons.style.alignItems = 'center'
    // // navButtons.style.position = 'absolute'
    // navButtons.style.width = '100%'
    // navButtons.style.height = '10%'
    // navButtons.style.top =  "100%"

    // navButtons.style.position =  'absolute'
    // navButtons.style.top = "100%"
    // navButtons.style.height = infoPage.style.height;
    // navButtons.style.margin = infoPage.style.margin;
    // navButtons.style.width = infoPage.style.width;
    // navButtons.style.left = infoPage.style.left;

    navButtons.style.border = '1px solid red'

    const backButton = document.getElementById("back-button");
    backButton.style.width = '30%'
    backButton.style.margin = '0 5%'
    const continueButton = document.getElementById("continue-button");
    continueButton.style.width = '30%'
    continueButton.style.margin = '0 5%'

    backButton.addEventListener("click", function() { user_input.store('button','back') });
    continueButton.addEventListener("click", function() { user_input.store('button','continue')});

    // Survey-Frame ==========================================
    const surveyFrame = document.getElementById("survey-frame");
    surveyFrame.style.position = infoPage.style.position
    surveyFrame.style.top = infoPage.style.top
    surveyFrame.style.height = infoPage.style.height;
    surveyFrame.style.margin = infoPage.style.margin;
    surveyFrame.style.width = infoPage.style.width;
    surveyFrame.style.left = infoPage.style.left;
    surveyFrame.style.border = '1px solid red'


    const table = document.getElementById("survey-table");
    table.style.textAlign = "center";
    table.style.margin = "auto";
    table.style.width = "50%";
    table.style.tableLayout = "fixed" ;
    const surveyForm =  document.getElementById("survey-form");
    surveyForm.style.height = infoPage.style.height
    surveyForm.style.top = surveyFrame.clientHeight / 2 - surveyForm.height / 2 + 'px';
    surveyForm.style.left =  surveyFrame.clientWidth / 2 - surveyForm.width / 2 + 'px';
    surveyForm.style.position = 'absolute'

    const submitButton = document.getElementById("submit-survey-button");
    submitButton.style.position = 'absolute';
    submitButton.style.top = '50%';
    submitButton.style.left = '50%';
    submitButton.style.transform = 'translate(-50%,-50%)';
    submitButton.style.width = '30%'
    submitButton.style.margin = '0 5%'



    //
    // const backButton = document.getElementById("back-button");
    // backButton.style.width = '30%'
    // backButton.style.margin = '0 5%'
    // const continueButton = document.getElementById("continue-button");
    // continueButton.style.width = '30%'
    // continueButton.style.margin = '0 5%'
    let user_input = new UserInput()
    let G = new Game([1,0,3,3,1,0]);

    //

    G.render()
    hide_all()
    show('info-frame')
    // $(document).keydown(  user_input.store('keypress',decode_keypress(e)))


    $(document).keydown(function(e) {
    if (e.keyCode === 37) {  if (G.playing) user_input.store('keypress','left')
    } else if (e.keyCode === 38) { if (G.playing)  user_input.store('keypress','up') //up
    } else if (e.keyCode === 39) { if (G.playing)  user_input.store('keypress','right') //right
    } else if (e.keyCode === 40) { if (G.playing)  user_input.store('keypress','down') //down
    } else if (e.keyCode === 32) { if (G.playing)  user_input.store('keypress','spacebar')
    } // else {   console.log(e) }
})

    $(document).ready(function() {
      const socket = io();
      // let G = new Game(1,[2,1,3,3,5,5]);

      function client_update() {
        const user_input_buffer =  user_input.read_buffer()
        socket.emit('update_gamestate', user_input_buffer)
      }

      // Emit actions on .js event ######################################################
      setInterval(client_update, update_rate) // 1 millisecond is almost close to continu


      // Update game data on response from server ##########################################
      socket.on( 'update_gamestate', (data)=>{
        // console.log(data)
        if (data['view'] !== current_view){
            hide_all()
            show(data['view'])
            current_view = data['view']
            console.log('Changing view to '+current_view)
        }


        G.update(data)
        G.render()
      })
    })

  </script>


</main>

{% endblock %}

